<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>시니어아이 - 데이케어 수업 통합 플랫폼</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <!-- ✅ Your original structure preserved -->
  <header class="header">
    <h1>시니어아이</h1>
    <p>데이케어센터 수업을 한 번에 관리하세요</p>
  </header>

  <section class="hero">
    <div class="hero-content">
      <h2>센터의 현실, 우리가 해결합니다</h2>
      <p>디지털 기기 사용이 어려운 요양보호사들을 위한 쉽고 빠른 수업 플랫폼</p>
      <div class="cta-buttons">
        <button class="free-btn">무료버전 사전예약</button>
        <button class="pro-btn">유료버전 사전예약</button>
      </div>
    </div>
  </section>

  <!-- ✅ Reservation Form -->
  <section class="reservation">
    <h2>사전 예약하기</h2>
    <form id="preorder-form">
      <label>기관명</label>
      <input type="text" name="organization" required />

      <label>이름</label>
      <input type="text" name="name" required />

      <label>이메일</label>
      <input type="email" name="email" required />

      <label>전화번호</label>
      <input type="tel" name="phone" required />

      <input type="hidden" name="plan_type" id="plan_type" value="" />
      <button type="submit" class="submit-btn">사전 예약</button>
    </form>
  </section>

  <footer class="footer">
    <p>© 2025 시니어아이. All rights reserved.</p>
  </footer>

  <!-- ===================================================== -->
  <!-- ✅ SESSION + ANALYTICS HELPERS -->
  <!-- ===================================================== -->
  <script>
  // --- Create / get persistent session ID ---
  function getSid() {
    const KEY = 'sess_id_v1';
    let sid = localStorage.getItem(KEY);
    if (!sid) {
      sid = (crypto && crypto.randomUUID)
        ? crypto.randomUUID()
        : (Date.now().toString(16) + Math.random().toString(16).slice(2));
      localStorage.setItem(KEY, sid);
    }
    return sid;
  }

  // --- Generic analytics collector ---
  async function sendCollect(event_type, extra = {}) {
    const payload = {
      event_type,
      session_id: getSid(),
      page_url: location.href,
      referrer: document.referrer || null,
      language: navigator.language || null,
      screen_w: window.innerWidth,
      screen_h: window.innerHeight,
      extra
    };

    const body = JSON.stringify(payload);
    let sent = false;
    try { sent = navigator.sendBeacon('/api/collect', body); } catch (_) {}
    if (!sent) {
      try {
        await fetch('/api/collect', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          keepalive: true,
          body
        });
      } catch (_) {}
    }
  }
  </script>

  <!-- ===================================================== -->
  <!-- ✅ PAGE ANALYTICS: page_view / heartbeat / page_close -->
  <!-- ===================================================== -->
  <script>
  (function () {
    const sid = getSid();
    const start = Date.now();
    sendCollect('page_view');

    // heartbeat every 15s
    setInterval(() => {
      const elapsed = Date.now() - start;
      sendCollect('heartbeat', { elapsed_ms: elapsed });
    }, 15000);

    // page_close
    window.addEventListener('beforeunload', () => {
      const elapsed = Date.now() - start;
      navigator.sendBeacon('/api/collect', JSON.stringify({
        event_type: 'page_close',
        session_id: sid,
        page_url: location.href,
        referrer: document.referrer || null,
        elapsed_ms: elapsed,
        language: navigator.language || null,
        screen_w: window.innerWidth,
        screen_h: window.innerHeight
      }));
    });
  })();
  </script>

  <!-- ===================================================== -->
  <!-- ✅ CTA Buttons: Free / Pro preorders -->
  <!-- ===================================================== -->
  <script>
  (function () {
    const freeBtn = document.querySelector('.free-btn');
    const proBtn = document.querySelector('.pro-btn');
    const planInput = document.querySelector('#plan_type');

    if (freeBtn) {
      freeBtn.addEventListener('click', () => {
        planInput.value = 'free';
        sendCollect('cta_free_preorder', { plan: 'free' });
        document.querySelector('#preorder-form').scrollIntoView({ behavior: 'smooth' });
      });
    }

    if (proBtn) {
      proBtn.addEventListener('click', () => {
        planInput.value = 'pro';
        sendCollect('cta_pro_preorder', { plan: 'pro' });
        document.querySelector('#preorder-form').scrollIntoView({ behavior: 'smooth' });
      });
    }
  })();
  </script>

  <!-- ===================================================== -->
  <!-- ✅ FORM SUBMISSION HANDLER -->
  <!-- ===================================================== -->
  <script>
  (function () {
    const form = document.querySelector('#preorder-form');
    if (!form) return;

    let busy = false;
    form.addEventListener('submit', function (e) {
      e.preventDefault();
      if (busy) return;
      busy = true;

      const btn = form.querySelector('button[type="submit"]');
      if (btn) {
        btn.disabled = true;
        btn.dataset._old = btn.textContent;
        btn.textContent = '전송 중...';
      }

      const fd = new FormData(form);
      const payload = {
        event_type: 'form_submit',
        session_id: getSid(),
        page_url: location.href,
        referrer: document.referrer || null,
        name: fd.get('name') || null,
        organization: fd.get('organization') || null,
        phone: fd.get('phone') || null,
        email: fd.get('email') || null,
        plan_type: fd.get('plan_type') || fd.get('plan') || fd.get('type') || null
      };

      const body = JSON.stringify(payload);
      let sent = false;
      try { sent = navigator.sendBeacon('/api/collect', body); } catch (_) {}
      if (!sent) {
        fetch('/api/collect', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          keepalive: true,
          body
        }).catch(() => {});
      }

      setTimeout(() => {
        alert('사전예약이 접수되었습니다. 곧 연락드릴게요!');
        if (btn) {
          btn.disabled = false;
          btn.textContent = btn.dataset._old || '사전 예약';
        }
        busy = false;
      }, 250);
    });
  })();
  </script>

</body>
</html>
