<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ì‹œë‹ˆì•„ì´ â€“ ì„¼í„° í”„ë¡œê·¸ë¨ í™”ë©´</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="ì‹œë‹ˆì•„ì´ ì„¼í„°ë³„ í”„ë¡œê·¸ë¨ ì¼ì • ì•ˆë‚´ í™”ë©´" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --app-main: #f0a223;
      --app-main-dark: #d68f1f;
      --app-main-soft: #fff2cb;
      --app-bg: #fff9ef;
    }
    html { scroll-behavior: smooth; }
    body {
      background: var(--app-bg);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    /* ë“œë¡œì–´ (ì˜¤ë¥¸ìª½ ìŠ¬ë¼ì´ë“œ íŒ¨ë„) */
    #drawer-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.4);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
      z-index: 40;
    }
    #drawer-backdrop.open {
      opacity: 1;
      pointer-events: auto;
    }
    #drawer {
      position: fixed;
      top: 0;
      right: 0;
      width: min(360px, 100%);
      height: 100%;
      background: #ffffff;
      box-shadow: -8px 0 24px rgba(15, 23, 42, 0.18);
      transform: translateX(100%);
      transition: transform 0.25s ease;
      z-index: 50;
      display: flex;
      flex-direction: column;
    }
    #drawer.open {
      transform: translateX(0);
    }

    /* ì„¼í„° ì„ íƒ ì˜¤ë²„ë ˆì´ (displayëŠ” Tailwindì˜ hidden/flexë¡œ ì œì–´) */
    #center-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.6);
      z-index: 60;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <!-- ìƒë‹¨ í—¤ë” -->
  <header class="w-full bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-2xl flex items-center justify-center text-white font-bold"
             style="background: linear-gradient(135deg, #f0a223, #f59e0b);">
          S
        </div>
        <div class="flex flex-col">
          <span class="text-sm font-semibold text-slate-900">
            ì‹œë‹ˆì•„ì´ í”„ë¡œê·¸ë¨ í™”ë©´
          </span>
          <span id="header-center-name" class="text-xs text-slate-500">
            ì„¼í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”
          </span>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btn-change-center"
                class="text-[11px] px-3 py-1.5 rounded-full border border-slate-200 text-slate-700 hover:border-[var(--app-main)] hover:text-[var(--app-main-dark)]">
          ì„¼í„° ë³€ê²½
        </button>
        <button id="btn-open-drawer"
                class="hidden sm:inline-flex text-[11px] px-3 py-1.5 rounded-full text-white font-medium"
                style="background: linear-gradient(135deg, #f0a223, #f59e0b);">
          ì˜¤ëŠ˜ ì¼ì • ë³´ê¸°
        </button>
      </div>
    </div>
  </header>

  <!-- ë©”ì¸ ì˜ì—­ -->
  <main class="flex-1">
    <div class="max-w-5xl mx-auto px-4 py-6 space-y-4">

      <!-- ì§€ê¸ˆ ì§„í–‰ ì¤‘ì¸ í”„ë¡œê·¸ë¨ -->
      <section class="rounded-2xl border border-amber-100 bg-white px-4 py-4 sm:px-6 sm:py-6 shadow-sm">
        <div class="flex items-center justify-between gap-2 mb-3">
          <div>
            <h2 class="text-lg sm:text-xl font-semibold text-slate-900">
              ì§€ê¸ˆ ì§„í–‰ ì¤‘ì¸ í”„ë¡œê·¸ë¨
            </h2>
            <p class="text-[11px] sm:text-xs text-slate-500 mt-0.5">
              í˜„ì¬ ì‹œê°„ì— í•´ë‹¹í•˜ëŠ” í™œë™ê³¼ ìˆ˜ì—…ëª…ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
            </p>
          </div>
          <button id="btn-open-drawer-mobile"
                  class="sm:hidden text-[11px] px-3 py-1.5 rounded-full text-white font-medium"
                  style="background: linear-gradient(135deg, #f0a223, #f97316);">
            ì˜¤ëŠ˜ ì¼ì •
          </button>
        </div>

        <div id="current-block-box" class="rounded-xl border border-amber-100 bg-[var(--app-bg)] px-4 py-4 sm:px-5 sm:py-5">
          <div id="current-block-time" class="text-sm sm:text-base font-medium text-amber-800 mb-1">
            ì‹œê°„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
          </div>
          <div id="current-block-title" class="text-2xl sm:text-3xl font-bold text-slate-900 mb-3 leading-snug">
            -
          </div>
          <div id="current-block-activity" class="text-sm sm:text-base text-slate-700 leading-relaxed">
            ì„¼í„°ì™€ ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê¸°ì¤€ìœ¼ë¡œ í”„ë¡œê·¸ë¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤.
          </div>
          <!-- ğŸ”¹ ì—¬ê¸° ê²Œì„ ì˜ì—­ ì¶”ê°€ -->
          <div id="current-block-game" class="mt-4"></div>
        </div>
      </section>

      <!-- ë‹¤ìŒ í”„ë¡œê·¸ë¨ -->
      <section class="rounded-2xl border border-amber-100 bg-white px-4 py-4 sm:px-6 sm:py-5 shadow-sm">
        <div class="flex items-center justify-between gap-2 mb-3">
          <h2 class="text-base sm:text-lg font-semibold text-slate-900">
            ë‹¤ìŒ í”„ë¡œê·¸ë¨
          </h2>
        </div>

        <div id="next-block-box" class="rounded-xl border border-dashed border-amber-200 bg-[var(--app-bg)] px-4 py-3 sm:px-5 sm:py-4 text-sm sm:text-base text-slate-700">
          ë‹¤ìŒ í”„ë¡œê·¸ë¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
        </div>
      </section>

    </div>
  </main>

  <!-- ë“œë¡œì–´: ì˜¤ëŠ˜ ì¼ì • ì „ì²´ ë³´ê¸° -->
  <div id="drawer-backdrop"></div>
  <aside id="drawer">
    <!-- ë“œë¡œì–´ í—¤ë” -->
    <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200">
      <div class="flex flex-col">
        <span class="text-sm font-semibold text-slate-900">ì˜¤ëŠ˜ ì¼ì •</span>
        <span id="drawer-center-name" class="text-[11px] text-slate-500"></span>
      </div>
      <button id="btn-close-drawer"
              class="text-xs px-2 py-1 rounded-full border border-slate-200 text-slate-600 hover:border-amber-400 hover:text-amber-700">
        ë‹«ê¸° âœ•
      </button>
    </div>

    <!-- ë“œë¡œì–´ ì•ˆì˜ ì‹œê°„Â·ë‚ ì§œ íŒ¨ë„ -->
    <div class="px-4 py-3 border-b border-slate-100">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-2xl flex items-center justify-center text-white text-lg font-semibold"
             style="background: linear-gradient(135deg, #f0a223, #f97316);">
          â°
        </div>
        <div>
          <div id="today-date" class="text-xs text-slate-700"></div>
          <div id="current-time" class="text-lg font-bold text-slate-900"></div>
        </div>
      </div>
      <p class="mt-2 text-[10px] text-slate-500">
        í™”ë©´ ê¸€ìê°€ ì‘ê²Œ ëŠê»´ì§€ë©´ TV ë˜ëŠ” ë¸Œë¼ìš°ì €ì—ì„œ í™•ëŒ€(âŒ˜+ / Ctrl+) ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.
      </p>
    </div>

    <!-- ì¼ì • ë¦¬ìŠ¤íŠ¸ -->
    <div class="flex-1 overflow-y-auto px-3 py-3">
      <div id="drawer-schedule" class="space-y-2 text-sm">
        <!-- JSì—ì„œ ì¼ì • ë Œë”ë§ -->
      </div>
    </div>
  </aside>

  <!-- ì„¼í„° ì„ íƒ ì˜¤ë²„ë ˆì´ -->
  <div id="center-overlay" class="hidden flex items-center justify-center">
    <div class="max-w-sm w-full bg-white rounded-2xl shadow-xl px-5 py-6">
      <h2 class="text-lg font-semibold text-slate-900 mb-1">
        ì„¼í„° ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”
      </h2>
      <p class="text-[11px] text-slate-500 mb-4">
        ì˜ˆ: ì•„í˜„ì‹¤ë²„ë°ì´ì¼€ì–´ì„¼í„°<br/>
        (ë¸Œë¼ìš°ì €ì— ê¸°ì–µë˜ì–´ ë‹¤ìŒ ì ‘ì†ë¶€í„° ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.)
      </p>
      <label for="center-input-overlay" class="block text-xs font-medium text-slate-700 mb-1">
        ì„¼í„° ì´ë¦„
      </label>
      <input
        id="center-input-overlay"
        type="text"
        class="w-full border rounded-lg px-3 py-2 text-sm mb-2 focus:outline-none focus:ring-2 focus:ring-[var(--app-main)] focus:border-[var(--app-main)]"
        placeholder="ì˜ˆ: ì•„í˜„ì‹¤ë²„ë°ì´ì¼€ì–´ì„¼í„°"
      />
      <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
      <p id="center-error" class="mb-2 text-[11px] text-red-500 hidden">
        ì…ë ¥í•˜ì‹  ê¸°ê´€ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
      </p>
      <button id="btn-confirm-center"
              class="w-full py-2.5 rounded-lg text-sm font-semibold text-white"
              style="background: linear-gradient(135deg, #f0a223, #f97316);">
        ì´ ì„¼í„°ë¡œ ì‹œì‘í•˜ê¸°
      </button>
      <p class="mt-3 text-[10px] text-slate-500">
        * URLì— <code>?center=ì•„í˜„ì‹¤ë²„ë°ì´ì¼€ì–´ì„¼í„°</code> ë˜ëŠ”
        <code>/app/ì•„í˜„ì‹¤ë²„ë°ì´ì¼€ì–´ì„¼í„°</code> í˜•ì‹ìœ¼ë¡œ ì ‘ì†í•˜ë©´ ìë™ìœ¼ë¡œ ì¸ì‹í•©ë‹ˆë‹¤.
      </p>
    </div>
  </div>

  <!-- ğŸ”¹ ê²Œì„ ìŠ¤í¬ë¦½íŠ¸ (spot_diff) -->
  <script src="./games/spot_diff.js"></script>

  <script>
    // ================================
    // Supabase ì—°ê²° ì„¤ì •
    // ================================
    const SUPABASE_URL = 'https://cttqnwngksbrvtveoqpv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0dHFud25na3NicnZ0dmVvcXB2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1ODc2NzgsImV4cCI6MjA3NzE2MzY3OH0.IBtCyc01ptYUyDeEYx6rAo31IfdSiP3AgTRi8nAowrI';

    const TABLE_DAILY   = 'daily_templates';
    const TABLE_MONTHLY = 'monthly_programs';

    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ================================
    // ìƒíƒœ ë³€ìˆ˜
    // ================================
    let centerName = '';
    let dailyBlocks = [];           // [{block_index,start_time,end_time,label}, ...]
    let monthlyActivities = {};     // { 1: '...', 2: '...', 3: '...' }
    let clockTimer = null;

    // ê¸°ë³¸ ì¼ì¼ í…œí”Œë¦¿ (DBì— ì—†ì„ ë•Œ fallback)
    const defaultDailyBlocks = [
      { block_index: 1,  start_time: '08:00', end_time: '10:20', label: 'ì•„ì¹¨ì†¡ì˜' },
      { block_index: 2,  start_time: '10:20', end_time: '11:00', label: 'ì•„ì¹¨ì¡°íšŒ' },
      { block_index: 3,  start_time: '11:00', end_time: '12:00', label: 'ìˆ˜ì—… 1' },
      { block_index: 4,  start_time: '12:00', end_time: '13:00', label: 'ì ì‹¬ ì‹ì‚¬' },
      { block_index: 5,  start_time: '13:00', end_time: '14:00', label: 'íœ´ì‹/ì˜¤ì¹¨' },
      { block_index: 6,  start_time: '14:00', end_time: '15:00', label: 'ìˆ˜ì—… 2' },
      { block_index: 7,  start_time: '15:00', end_time: '15:30', label: 'ê°„ì‹' },
      { block_index: 8,  start_time: '15:30', end_time: '16:00', label: 'ìƒí™œ êµìœ¡' },
      { block_index: 9,  start_time: '16:00', end_time: '17:00', label: 'ìˆ˜ì—… 3' },
      { block_index: 10, start_time: '17:00', end_time: '18:00', label: 'ì†¡ì˜' }
    ];

    // ================================
    // DOM ìš”ì†Œ
    // ================================
    const headerCenterNameEl = document.getElementById('header-center-name');
    const drawerCenterNameEl = document.getElementById('drawer-center-name');

    const todayDateEl   = document.getElementById('today-date');
    const currentTimeEl = document.getElementById('current-time');

    const currentBlockTimeEl     = document.getElementById('current-block-time');
    const currentBlockTitleEl    = document.getElementById('current-block-title');
    const currentBlockActivityEl = document.getElementById('current-block-activity');
    const currentBlockGameEl     = document.getElementById('current-block-game');

    const nextBlockBoxEl         = document.getElementById('next-block-box');
    const drawerBackdropEl       = document.getElementById('drawer-backdrop');
    const drawerEl               = document.getElementById('drawer');
    const drawerScheduleEl       = document.getElementById('drawer-schedule');

    const btnChangeCenter        = document.getElementById('btn-change-center');
    const btnOpenDrawer          = document.getElementById('btn-open-drawer');
    const btnOpenDrawerMobile    = document.getElementById('btn-open-drawer-mobile');
    const btnCloseDrawer         = document.getElementById('btn-close-drawer');

    const centerOverlayEl        = document.getElementById('center-overlay');
    const centerInputOverlayEl   = document.getElementById('center-input-overlay');
    const btnConfirmCenter       = document.getElementById('btn-confirm-center');
    const centerErrorEl          = document.getElementById('center-error');

    // ================================
    // ìœ í‹¸ í•¨ìˆ˜
    // ================================
    function hhmmToMinutes(hhmm) {
      if (!hhmm || typeof hhmm !== 'string') return 0;
      const [h, m] = hhmm.split(':').map((x) => parseInt(x, 10) || 0);
      return h * 60 + m;
    }

    function getKoreanDayName(d) {
      const names = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      return names[d.getDay()];
    }

    function formatDateLabel(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      const dow = getKoreanDayName(d);
      return `${y}ë…„ ${m}ì›” ${day}ì¼ (${dow})`;
    }

    function todayISO() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }

    function slotFromLabel(label) {
      if (!label) return null;
      const m = label.match(/ìˆ˜ì—…\s*([123])/);
      if (!m) return null;
      const n = parseInt(m[1], 10);
      return isNaN(n) ? null : n;
    }

    function parseCenterFromURL() {
      const url = new URL(location.href);

      // ?center=ì•„í˜„ì‹¤ë²„ë°ì´ì¼€ì–´ì„¼í„°
      const qsCenter = url.searchParams.get('center');
      if (qsCenter) return decodeURIComponent(qsCenter);

      // /app/ì•„í˜„ì‹¤ë²„ë°ì´ì¼€ì–´ì„¼í„° í˜•íƒœ ì§€ì›
      const segments = location.pathname.split('/').filter(Boolean);
      if (segments.length >= 2) {
        const last = segments[segments.length - 1];
        if (last !== 'app' && last !== 'index.html') {
          try {
            return decodeURIComponent(last);
          } catch {
            return last;
          }
        }
      }
      return '';
    }

    function resolveInitialCenter() {
      // URLì— ìˆìœ¼ë©´ URL ìš°ì„ 
      const urlCenter = parseCenterFromURL();
      if (urlCenter) {
        localStorage.setItem('senioreye_center', urlCenter);
        return urlCenter;
      }
      // ë¡œì»¬ ì €ì¥ëœ ì„¼í„°
      const saved = localStorage.getItem('senioreye_center');
      if (saved) return saved;
      return '';
    }

    function openCenterOverlay() {
      if (!centerOverlayEl) return;
      centerOverlayEl.classList.remove('hidden');
      if (centerErrorEl) centerErrorEl.classList.add('hidden');
      setTimeout(() => centerInputOverlayEl && centerInputOverlayEl.focus(), 50);
    }

    function closeCenterOverlay() {
      if (!centerOverlayEl) return;
      centerOverlayEl.classList.add('hidden');
      if (centerErrorEl) centerErrorEl.classList.add('hidden');
    }

    function showCenterError(msg) {
      if (!centerErrorEl) return;
      centerErrorEl.textContent = msg || 'ì…ë ¥í•˜ì‹  ê¸°ê´€ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
      centerErrorEl.classList.remove('hidden');
    }

    function hideCenterError() {
      if (!centerErrorEl) return;
      centerErrorEl.classList.add('hidden');
    }

    function openDrawer() {
      drawerBackdropEl.classList.add('open');
      drawerEl.classList.add('open');
    }

    function closeDrawer() {
      drawerBackdropEl.classList.remove('open');
      drawerEl.classList.remove('open');
    }

    // ê²Œì„ ì˜ì—­ ì´ˆê¸°í™” / ë Œë”ë§
    function clearGame() {
      if (currentBlockGameEl) {
        currentBlockGameEl.innerHTML = '';
      }
    }

    function renderGameForActivity(activityName) {
      if (!currentBlockGameEl) return;
      clearGame();
      if (!activityName) return;

      // ğŸ”¸ ì—¬ê¸°ì„œ activity í…ìŠ¤íŠ¸ì™€ ê²Œì„ì„ ë§¤ì¹­
      // ì˜ˆ: activity === "ì¸ì§€ë ¥ ê°•í™”" â†’ spot_diff.js ì‹¤í–‰
      if (activityName === 'ì¸ì§€ë ¥ ê°•í™”' && window.renderSpotDiffGame) {
        window.renderSpotDiffGame(currentBlockGameEl);
      }
      // ë‚˜ì¤‘ì— ë‹¤ë¥¸ ê²Œì„:
      // else if (activityName === 'ê¸°ì–µë ¥ ê²Œì„' && window.renderMemoryGame) { ... }
    }

    // ================================
    // Supabaseì—ì„œ ì„¼í„° ì¡´ì¬ ì—¬ë¶€ í™•ì¸
    // ================================
    async function checkCenterExists(name) {
      if (!name) return false;
      try {
        const { data, error } = await db
          .from(TABLE_DAILY)
          .select('center_name')
          .eq('center_name', name)
          .limit(1);

        if (error) {
          console.error('checkCenterExists error:', error);
          return false;
        }
        return !!(data && data.length > 0);
      } catch (e) {
        console.error('checkCenterExists exception:', e);
        return false;
      }
    }

    // ================================
    // Supabase ë°ì´í„° ë¡œë”©
    // ================================
    async function loadDailyTemplateForCenter() {
      if (!centerName) return;
      try {
        const { data, error } = await db
          .from(TABLE_DAILY)
          .select('block_index, start_time, end_time, label')
          .eq('center_name', centerName)
          .order('block_index', { ascending: true });

        if (error) {
          console.error('loadDailyTemplate error:', error);
          dailyBlocks = [...defaultDailyBlocks];
          return;
        }
        if (!data || data.length === 0) {
          dailyBlocks = [...defaultDailyBlocks];
          return;
        }

        dailyBlocks = data.map((row) => ({
          block_index: row.block_index,
          start_time: (row.start_time || '').slice(0, 5),
          end_time:   (row.end_time   || '').slice(0, 5),
          label:      row.label || ''
        }));
      } catch (e) {
        console.error('loadDailyTemplate exception:', e);
        dailyBlocks = [...defaultDailyBlocks];
      }
    }

    async function loadTodayMonthlyForCenter() {
      if (!centerName) return;
      try {
        const iso = todayISO();
        const { data, error } = await db
          .from(TABLE_MONTHLY)
          .select('class_slot, activity')
          .eq('center_name', centerName)
          .eq('class_date', iso);

        if (error) {
          console.error('loadTodayMonthly error:', error);
          monthlyActivities = {};
          return;
        }

        monthlyActivities = {};
        (data || []).forEach((row) => {
          monthlyActivities[row.class_slot] = row.activity || '';
        });
      } catch (e) {
        console.error('loadTodayMonthly exception:', e);
        monthlyActivities = {};
      }
    }

    // ================================
    // í™”ë©´ ë Œë”ë§
    // ================================
    function updateClock() {
      const now = new Date();
      if (todayDateEl) todayDateEl.textContent = formatDateLabel(now);

      const h = String(now.getHours()).padStart(2, '0');
      const m = String(now.getMinutes()).padStart(2, '0');
      if (currentTimeEl) currentTimeEl.textContent = `${h}:${m}`;
    }

    function findCurrentAndNextBlock() {
      if (!dailyBlocks || dailyBlocks.length === 0) return { current: null, next: null };

      const now = new Date();
      const nowMinutes = now.getHours() * 60 + now.getMinutes();

      const sortedBlocks = [...dailyBlocks].sort((a, b) => a.block_index - b.block_index);

      let current = null;
      let next    = null;

      for (let i = 0; i < sortedBlocks.length; i++) {
        const b = sortedBlocks[i];
        const startM = hhmmToMinutes(b.start_time);
        const endM   = hhmmToMinutes(b.end_time);

        if (nowMinutes >= startM && nowMinutes < endM) {
          current = b;
          next = sortedBlocks[i + 1] || null;
          break;
        }
        if (nowMinutes < startM) {
          // ì•„ì§ ì‹œì‘ ì „
          current = null;
          next = b;
          break;
        }
      }

      if (!current && !next && sortedBlocks.length > 0) {
        // í•˜ë£¨ ì¼ì •ì´ ëª¨ë‘ ëë‚œ ë’¤
        const last = sortedBlocks[sortedBlocks.length - 1];
        if (nowMinutes < hhmmToMinutes(last.start_time)) {
          next = last;
        }
      }

      return { current, next };
    }

    function renderCurrentAndNext() {
      updateClock();

      const { current, next } = findCurrentAndNextBlock();
      let activityNameForGame = null;  // í˜„ì¬ ë¸”ë¡ì— ë§¤ì¹­ë˜ëŠ” activity

      // ==== ì§€ê¸ˆ ì§„í–‰ ì¤‘ì¸ í”„ë¡œê·¸ë¨ ====
      if (!current) {
        currentBlockTimeEl.textContent = 'í˜„ì¬ ì§„í–‰ ì¤‘ì¸ í”„ë¡œê·¸ë¨ì´ ì—†ìŠµë‹ˆë‹¤.';
        currentBlockTitleEl.textContent = 'ì§€ê¸ˆì€ ììœ  ì‹œê°„ì…ë‹ˆë‹¤';
        currentBlockActivityEl.textContent =
          'ë‹¤ìŒ í”„ë¡œê·¸ë¨ ì‹œê°„ê¹Œì§€ ì–´ë¥´ì‹ ê³¼ ììœ ë¡­ê²Œ ëŒ€í™”í•˜ê±°ë‚˜ íœ´ì‹ ì‹œê°„ì„ ê°€ì§€ì…”ë„ ì¢‹ìŠµë‹ˆë‹¤.';
        clearGame();
      } else {
        currentBlockTimeEl.textContent = `${current.start_time} ~ ${current.end_time}`;

        const slot = slotFromLabel(current.label); // ìˆ˜ì—… 1 / 2 / 3 ì—ì„œ ë²ˆí˜¸ ì¶”ì¶œ
        let titleText = current.label || 'í”„ë¡œê·¸ë¨'; // ê¸°ë³¸ê°’: ìˆ˜ì—… 3 ì´ëŸ° ë¼ë²¨
        let descText  = 'ì‹œê°„í‘œì— ë“±ë¡ëœ ê¸°ë³¸ í™œë™ì…ë‹ˆë‹¤.';

        // monthly_programsì— í•´ë‹¹ ìˆ˜ì—… ìŠ¬ë¡¯ì´ ìˆìœ¼ë©´ â†’ ê·¸ activityë¥¼ ì œëª©ìœ¼ë¡œ ì‚¬ìš©
        if (slot && monthlyActivities[slot]) {
          titleText = monthlyActivities[slot];           // ì˜ˆ: "ì¸ì§€ë ¥ ê°•í™”"
          descText  = `ìˆ˜ì—… ${slot} í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤.`;     // ì•„ë˜ ì‘ì€ ì„¤ëª…
          activityNameForGame = monthlyActivities[slot]; // ê²Œì„ ë§¤ì¹­ìš©
        } else if (slot && !monthlyActivities[slot]) {
          descText = 'ì˜¤ëŠ˜ ìˆ˜ì—… ë‚´ìš©ì´ ì•„ì§ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
        }

        currentBlockTitleEl.textContent    = titleText;
        currentBlockActivityEl.textContent = descText;
      }

      // í˜„ì¬ activity ê¸°ì¤€ìœ¼ë¡œ ê²Œì„ ë Œë”ë§
      renderGameForActivity(activityNameForGame);

      // ==== ë‹¤ìŒ í”„ë¡œê·¸ë¨ ====
      if (!next) {
        nextBlockBoxEl.textContent = 'ì˜¤ëŠ˜ ì˜ˆì •ëœ ë‹¤ìŒ í”„ë¡œê·¸ë¨ì´ ì—†ìŠµë‹ˆë‹¤.';
      } else {
        const slotNext = slotFromLabel(next.label);
        let nextTitle = next.label || 'í”„ë¡œê·¸ë¨';
        let nextDesc  = 'ë‹¤ìŒ í™œë™ì´ ì‹œê°„í‘œì— ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.';

        if (slotNext && monthlyActivities[slotNext]) {
          nextTitle = monthlyActivities[slotNext];
          nextDesc  = `ìˆ˜ì—… ${slotNext} í”„ë¡œê·¸ë¨: ${monthlyActivities[slotNext]}`;
        } else if (slotNext && !monthlyActivities[slotNext]) {
          nextDesc = `ìˆ˜ì—… ${slotNext} í”„ë¡œê·¸ë¨: ì•„ì§ ë¯¸ë“±ë¡`;
        }

        nextBlockBoxEl.innerHTML = `
          <div class="font-medium text-amber-800 mb-1">
            ${next.start_time} ~ ${next.end_time}
          </div>
          <div class="font-semibold text-slate-900 mb-1">
            ${nextTitle}
          </div>
          <div class="text-slate-700 text-sm">
            ${nextDesc}
          </div>
        `;
      }

      renderDrawerSchedule();
    }

    function renderDrawerSchedule() {
      drawerScheduleEl.innerHTML = '';

      if (!dailyBlocks || dailyBlocks.length === 0) {
        drawerScheduleEl.innerHTML = '<div class="text-xs text-slate-500">ì¼ì • ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      const now = new Date();
      const nowMin = now.getHours() * 60 + now.getMinutes();

      const sorted = [...dailyBlocks].sort((a, b) => a.block_index - b.block_index);

      sorted.forEach((b) => {
        const startM = hhmmToMinutes(b.start_time);
        const endM   = hhmmToMinutes(b.end_time);

        const isCurrent = nowMin >= startM && nowMin < endM;

        const slot = slotFromLabel(b.label);
        const activity = slot ? (monthlyActivities[slot] || '') : '';

        const item = document.createElement('div');
        item.className =
          'rounded-xl border px-3 py-2.5 text-sm flex flex-col gap-0.5 ' +
          (isCurrent ? 'border-amber-400 bg-[var(--app-main-soft)]' : 'border-slate-200 bg-white');

        const line1 = document.createElement('div');
        line1.className = 'flex items-center justify-between gap-2';
        line1.innerHTML = `
          <span class="text-xs font-medium text-amber-800">
            ${b.start_time} ~ ${b.end_time}
          </span>
          <span class="text-[10px] px-2 py-0.5 rounded-full ${
            isCurrent
              ? 'bg-amber-500 text-white'
              : 'bg-slate-100 text-slate-600'
          }">
            ${isCurrent ? 'ì§€ê¸ˆ' : 'ì˜ˆì •'}
          </span>
        `;
        item.appendChild(line1);

        const line2 = document.createElement('div');
        line2.className = 'font-semibold text-slate-900 text-sm';
        line2.textContent = b.label || 'í”„ë¡œê·¸ë¨';
        item.appendChild(line2);

        if (activity) {
          const line3 = document.createElement('div');
          line3.className = 'text-xs text-slate-700';
          line3.textContent = activity;
          item.appendChild(line3);
        } else if (slot) {
          const line3 = document.createElement('div');
          line3.className = 'text-xs text-slate-400';
          line3.textContent = 'ì˜¤ëŠ˜ ìˆ˜ì—… ë‚´ìš©ì´ ì•„ì§ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
          item.appendChild(line3);
        }

        drawerScheduleEl.appendChild(item);
      });
    }

    // ================================
    // ì´ˆê¸°í™” & ì´ë²¤íŠ¸
    // ================================
    async function loadDataAndRender() {
      if (!centerName) return;

      headerCenterNameEl.textContent = centerName;
      drawerCenterNameEl.textContent = `${centerName}`;

      await loadDailyTemplateForCenter();
      await loadTodayMonthlyForCenter();
      renderCurrentAndNext();

      if (clockTimer) clearInterval(clockTimer);
      clockTimer = setInterval(renderCurrentAndNext, 60 * 1000);
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // ì˜¤ëŠ˜ ë‚ ì§œ í‘œì‹œ ì´ˆê¸°í™”
      updateClock();

      // ì´ˆê¸° ì„¼í„° ê²°ì •
      centerName = resolveInitialCenter();

      if (centerName) {
        // URL / localStorageì—ì„œ ê°€ì ¸ì˜¨ ì„¼í„°ê°€ ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
        const exists = await checkCenterExists(centerName);
        if (!exists) {
          // ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ì´ˆê¸°ê°’ ì œê±° í›„ ë‹¤ì‹œ ì…ë ¥ ë°›ê¸°
          localStorage.removeItem('senioreye_center');
          centerName = '';
          openCenterOverlay();
        } else {
          await loadDataAndRender();
        }
      } else {
        openCenterOverlay();
      }

      // ì„¼í„° ë³€ê²½ ë²„íŠ¼
      btnChangeCenter.addEventListener('click', () => {
        centerInputOverlayEl.value = centerName || '';
        hideCenterError();
        openCenterOverlay();
      });

      // ì…ë ¥ ì¤‘ì—ëŠ” ì—ëŸ¬ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
      centerInputOverlayEl.addEventListener('input', () => {
        hideCenterError();
      });

      // ì„¼í„° í™•ì •
      btnConfirmCenter.addEventListener('click', async () => {
        const v = (centerInputOverlayEl.value || '').trim();
        if (!v) {
          alert('ì„¼í„° ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        hideCenterError();
        const exists = await checkCenterExists(v);
        if (!exists) {
          showCenterError('ì…ë ¥í•˜ì‹  ê¸°ê´€ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          return;
        }

        centerName = v;
        localStorage.setItem('senioreye_center', centerName);
        closeCenterOverlay();
        await loadDataAndRender();
      });

      centerInputOverlayEl.addEventListener('keydown', async (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          btnConfirmCenter.click();
        }
      });

      // ë“œë¡œì–´ ì—´ê¸°/ë‹«ê¸°
      function handleOpenDrawer() { openDrawer(); }
      function handleCloseDrawer() { closeDrawer(); }

      btnOpenDrawer?.addEventListener('click', handleOpenDrawer);
      btnOpenDrawerMobile?.addEventListener('click', handleOpenDrawer);
      btnCloseDrawer?.addEventListener('click', handleCloseDrawer);
      drawerBackdropEl.addEventListener('click', handleCloseDrawer);
    });
  </script>
</body>
</html>
